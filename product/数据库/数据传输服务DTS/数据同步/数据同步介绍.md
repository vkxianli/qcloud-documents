
## 概述
腾讯云数据同步服务支持 MySQL 数据库之间的数据实时同步，可应用于云上云下多活、异地多活、数据本地异地灾备、数据异地多活、跨境数据同步，及实时数据仓库等多种业务场景，助您构建安全、可扩展、高可用的数据架构。

## 支持的数据库
| **数据流向**            | **同步方向** | **源数据库**                    | **目标数据库**                   |
| --------------------- | ------------ | ------------------------------- | ---------------------------- |
| MySQL 数据库 > 云数据库 MySQL   | 入云      | <li>本地自建数据库<li>CVM 自建数据库<li>云数据库 MySQL  | 云数据库 MySQL              |
| MySQL 数据库 > 云数据仓库 PostgreSQL | 入云         | 云数据库 MySQL      | 云数据仓库 PostgreSQL              |
| 云上数据库 > MySQL 数据库           | 出云         | 云数据库 MySQL    | <li>本地自建数据库</li><li> CVM 自建数据库</li> |

>?
>- 入云指目标数据库为本云数据库产品的场景，出云指目标数据库为非本云数据库产品的场景。
>- 同步要求：源数据库或目标数据库中至少有一方为本云数据库实例。

## 支持的数据库版本
| **数据流向**            | **源数据库版本**                  | **目标数据库版本**            |
| ------------------- | --------------------------- | ------------------------------------- |
| MySQL 数据库 > 云数据库 MySQL   | MySQL 5.5.x<br>MySQL 5.6.x<br>MySQL 5.7.x<br>MySQL 8.0.x | MySQL 5.5<br>MySQL 5.6<br>MySQL 5.7<br>MySQL 8.0 |
| MySQL 数据库 > 云数据仓库 PostgreSQL  | MySQL 5.5.x<br>MySQL 5.6.x<br>MySQL 5.7.x<br>MySQL 8.0.x | CDW PG 1.0.0                                     |
| 云上数据库 > MySQL 数据库           | MySQL 5.5.x<br>MySQL 5.6.x<br>MySQL 5.7.x<br>MySQL 8.0.x | MySQL 5.5<br>MySQL 5.6<br>MySQL 5.7<br>MySQL 8.0 |

>?
>- 支持同版本间同步。
>- 支持低版本到高版本的同步。

## 产品架构及原理
用户通过数据同步服务控制台创建同步实例，同步实例由后台的任务管理/调度系统进行管理和调度，而数据同步系统则实际执行同步操作。监控系统确保第一时间发现同步实例异常，容灾系统确保整个系统稳定可用。
![](https://main.qcloudimg.com/raw/516e73c8fb889dd65c9d3e2779d54793.png)
- 数据同步服务控制台
主要是接收用户请求，对用户请求进行参数校验，请求转换操作，任务作业封装等。
- 任务管理调度系统
检测还有未执行的任务进行拉起，封装及处理，为真正的执行之前做准备。
- 执行系统
根据具体的业务类型来调用不同的业务驱动，执行数据同步操作。

数据同步基本原理，以 MySQL 实例为例：
![](https://main.qcloudimg.com/raw/906fe26fe9082d0e8b7206c247e3ccb2.png)
大致的流程为，数据从源实例中导出并导入到目标实例中，关键步骤包括结构初始化、存量数据库初始化及增量数据处理。
- 结构初始化
在开启同步任务后，可以选择是否同步库表结构，如果目标实例中已经创建了与源实例相同的结构信息，则可以不需要同步结构信息，只需要同步数据即可。否则需要进行结构初始化，结构初始化会自动在目标实例中创建与源实例相同的库表结构信息。
- 存量数据初始化
在结构信息同步完成后，会进行已有源实例中的存量数据的同步操作，会进行全量数据导出并导入到目标实例中。
- 增量数据处理
在进行全量数据同步操作同时会进行增量数据的处理操作，主要通过 Binlog 获取增量数据并进行一系列过滤转换操作后，将增量信息进行持久化缓存，在全量数据导入完成后再回放在这期间的增量变更数据，从而达到目标实例与源实例一致的状态。

## 功能特性和限制
同步服务的基本单元为单向同步，配置时可以选择对 DDL（Data Definition Language）、DML（Data Manipulation Language）进行同步。通过对单向同步进行组合，可以定制各种复杂的拓扑。
在复杂拓扑中，对于 DML 操作，我们会通过技术手段来避免数据循环的发生。而对于 DDL，数据同步服务会在配置时进行循环检测，避免形成 DDL 循环。

以下为一些常见拓扑，均可通过购买多个同步实例进行定制。
- 一对一单向同步
![](https://main.qcloudimg.com/raw/3d5d0513afd418b2ffae075e6cb9ed34.png)
- 级联单向同步
![](https://main.qcloudimg.com/raw/ca02fc489d9a89243ded1dca55c1e911.png)
- 一对多单向同步
![](https://main.qcloudimg.com/raw/8480d4d1995ee562db42a818e2f755b4.png)
- 多对一单向同步
![](https://main.qcloudimg.com/raw/fbf4046ebdec1bd2fa8c10308fb1c7c2.png)
- 双向同步
![](https://main.qcloudimg.com/raw/649e71b6ab67fc9d1cbbc2fef3f3e718.png)
- 级联双向同步
![](https://main.qcloudimg.com/raw/c8825ab212be90a9d943410d1ce31cc2.png)

#### 限制
通过对单向同步的组合，从而实现的双向同步，存在以下限制：
- 数据一致性的保持需要用户业务配合，即确保同一个主键数据只在一个节点进行更新。
- 如果发生数据同步冲突，通过数据冲突处理机制进行修复。
- DML 语句支持双向同步，DDL 语句只支持单向同步。构建双向同步，请确保其中一个单向实例禁止 DDL 同步。

## 典型场景
### 异地多活数据中心
通过腾讯云数据同步服务在多地域间的 MySQL 数据库实例间建立数据同步，可实现异地多活。其中各个地域的数据库实例可以运行在云上，也可以运行在企业自建数据中心。
![](https://main.qcloudimg.com/raw/cfa736f514c799e6c6405b0435dcb35d.png)

### 数据灾备
通过腾讯云数据同步服务实现对云下数据中心的容灾备份。
![](https://main.qcloudimg.com/raw/fcc880723dd80da86c766d7394a4a9fe.png)

## 热点问题
#### 源/目标实例发生 HA（High Availability）切换时，同步服务是否会受影响？
- 源实例支持并开启 GTID（Global Transaction Identifier）时，在增量同步阶段，如果源实例发生 HA，那么服务会自动重连，同步数据流在 HA 完成后迅速恢复
- 目标实例在增量同步阶段发生目标实例 HA，服务也会自动重连，同步数据流在 HA 完成后迅速恢复。

#### 支持将高版本实例的数据同步到低版本的实例吗？
不支持。同一个类型的数据库，目标实例的大版本必须不小于源实例。以 MySQL 实例为例，不支持 MySQL 5.7 的实例同步到 MySQL 5.6。

#### 源/目标能否为云下实例？
可以。可以将云上的数据库同步到云下，接入方式支持公网、云联网等。

#### 在双向同步拓扑中，是否可以对 DDL 进行双向同步？
不可以。创建同步实例时，只能允许其中一个实例进行 DDL 同步，否则检测算法检测到 DDL 循环，会禁止其中一个实例的创建。

#### 是否支持非事务引擎？
当前技术方案采用在事务中打上路由信息来标记事务的来源，依赖于事务的原子性。基于非事务引擎的库表，会破坏了事务的原子性，无法保证数据一致，不建议用户使用。
