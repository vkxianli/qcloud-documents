定位业务异常问题往往难度大、效率低，TAPM 不仅能通过错误分析功能采集代码执行过程中异常和错误，还可以采集日志中打印的异常信息，再结合事务追踪，可以快速、准确地定位业务异常问题，提升微服务框架下的开发诊断效率。

## 背景信息
- 错误：影响用户访问的事务请求的异常称之为错误，也叫事务错误。当一个请求发生多个事务错误时，只为该事务保留优先级最高的一个事务错误，其他的错误不进行统计。事务错误按优先级从高到低排序，包括：
  - Uncaught Exception
  - HTTP Error Code
  - Redirect Error Page
  - Logged Exception
  - Logged Error Message（开启 **设置事务状态为错误** 功能后）
- 异常：代码执行过程中产生的异常，不影响用户访问，统计范围如下：
  - 外部服务异常
  - 数据库异常
  - NoSQL 异常
  - MQ 异常
  - 代码异常
  - 日志组件记录的异常

## 问题分析
研发人员在定位应用错误和异常时，往往既要借助应用性能监控工具追查代码执行过程中异常和错误，又需要排查应用日志，双管齐下。在海量和分散的日志中找出某个请求的完整日志非常耗费时间。

## 解决方案
TAPM 的错误分析功能可以采集和统计日志组件输出的 error 及以上级别日志中的错误和异常信息，并对这些信息进行聚合分析，实现错误和异常根因诊断。 

## 准备工作
在定位具体的业务异常原因前，请确保已经为应用部署了 TAPM 探针，并对应用做以下配置：
1. 登录 [应用性能监控控制台](https://console.cloud.tencent.com/tapm)。
2. 在左侧导航栏中选择【配置】，然后在页面上方的【业务系统】下拉菜单中选择应用所属的业务系统。
3. 选择【应用设置】页签，单击【错误及异常】，然后单击右上角的【编辑】。
4. 在【日志组件】部分勾选单独配置，然后勾选您所使用的日志框架组件复选框，这样 TAPM 探针就可以采集和统计日志组件输出的 error 及以上级别日志中的异常信息，例如应用输出了日志 log.error("message","IOException")，那么 IOException 将会被采集。
   **日志级别高于 ERROR 的 message** 和**设置事务状态为错误**可根据需要勾选。
   - 日志级别高于 ‘error’ 的 ’message‘ ：默认情况下，对于 error 及以上级别的日志，如果日志中只有 message，而没有异常信息，是不会被统计为异常的。勾选该复选框后，上述日志也会被统计为异常。
   - 设置事务状态为错误：勾选后，error 及以上级别的日志所对应的事务会被视为错误，否则只被视为异常。 Logback 只有 error 级别的日志。
![](https://main.qcloudimg.com/raw/f0948a2dec219d59b124bb5aeb9cf8c9.png)
5. 单击【保存】按钮，保存应用配置。

## 定位步骤
1. 在左侧导航栏中选择【错误分析】，默认展示事务错误的分析图表。然后在页面上方的【业务系统】下拉菜单中选择应用所属的业务系统、应用，在右上角选择应用发生错误的时间段。
2. 页面下方的**事务错误列表**页签列出了应用发生的所有错误，默认按发生次数从高到低排序。单击一个发生次数较高的错误的名称，进入该错误的分析详情页面。
![](https://main.qcloudimg.com/raw/b3989c3bb2753e4338725770b48dcd96.png)
3. 在错误趋势图中，如果发现某个时段错误次数突然增加，可在图表下方的时间下拉菜单中选择最近时间段内的样本数据着重分析。
![](https://main.qcloudimg.com/raw/a69502f6abc3c5864e47601894eab81b.png)
   分析结果体现在下方的 Exception Messages 、错误追踪、 Client IPs 和 Caller Applications 部分。
   - Exception Messages：展示探针采集到的该种错误的所有错误 Message（已经过聚合），包括日志框架打印的错误信息和代码抛出的错误信息。单击某一行后，下方的错误追踪、Client IPs 和 Caller Applications 列表都会显示跟该条 Message 相关的数据。选择发生次数多，且占比较高的 Exception Messages 进行分析。
   - 错误追踪：展示所有发生了该错误信息的事务。其中 **Referer** 列显示发生了异常的事务所对应的请求的来源。
![](https://main.qcloudimg.com/raw/d2162d0ffa2a37d7f1cf5d5964fb8876.png)
   - Client IPs：展示所有发生了该错误的请求的客户端 IP 地址。
   - Caller Applications：展示所有调用发生过该错误的请求的上一级应用。
4. 单击一个事务名称，进入单个事务的追踪页面。
   在疑似问题概览部分，TAPM 自动分析出该事务执行过程中最慢的代码段、最耗时的组件调用和最严重的错误和异常信息。
   更进一步，您可以：
   - 在智能分析部分查看 CPU、内存、线程是否出现异常波动。
   - 在堆栈页面中探究具体原因，可能会是调用服务组件或外部服务出异常了、SQL 语句本身执行时间长、数据库连接池满了、代码本身的问题等等。该例中发现数据库异常，单击红框中的异常图标可查看异常信息和异常的堆栈，发现存在 SQL 语法问题。继续单击 **SQL 分析**页签，可追查具体影响到哪些完整的SQL 语句。
![](https://main.qcloudimg.com/raw/9eb4129ff77291aa91be74d9112ad7a1.png)
![](https://main.qcloudimg.com/raw/945ea28e8ecf34c01ba5c32df0f8d24f.png)
   - 在 **SQL 分析**和 **NoSQL 分析**页面看一下耗时情况。
5. 操作至此，您已发现了应用发生错误的原因，这将有效地帮助您进行下一步的代码优化工作。
>?关于事务异常的分析与上述事务错误分析类似，进入**错误分析**模块后，单击【异常】页签即可按相同的思路排查。


