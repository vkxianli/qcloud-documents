网站或 App 卡顿、页面加载过慢是互联网应用最常见的问题之一。针对这类问题，TAPM 应用性能监控提供线程剖析、事务追踪、错误分析、数据库分析、NoSQL 分析等一系列诊断手段，帮助您快速准确定位应用中所有慢事务，进而解决应用卡顿问题。
对于业务逻辑较简单的应用来说，登录机器查看日志的方式能够解决大部分网站报错的问题。

## 问题分析
定位应用卡顿问题的原因是一个比较复杂的系统工程。原因如下：
- 请求的调用链路长。
  - 从前端页面到 Web 应用服务器、后台应用、下游应用、数据库、MQ、NoSQL，任何一个环节出现问题都有可能导致应用卡顿。
  - 如果应用采用了微服务架构，调用链路会更加复杂，而且不同组件可能由不同的团队和人员维护，加大了问题排查的难度。
- 日志不全。
  追踪应用日志是排查应用问题的主要方法，但出现问题的位置往往无法预期，而且应用响应慢或卡顿通常是偶发现象，要找到慢的原因，需要为每次调用在每个可能出现问题的地方打印日志，这样成本会非常高。
- 代码监控不足
  由于应用快速的迭代，导致应用频繁修改接口等情况，代码的质量无法得到保证。这种情况下，需要一个强大的监控系统来自动监控应用的每一个接口，自动记录有性能问题的接口调用。

## 解决方案
TAPM 提供线程剖析、事务追踪、错误分析、数据库分析、NoSQL 分析等一系列诊断手段，帮助您快速准确定位应用中所有慢事务，进而解决应用卡顿问题。

## 诊断步骤
在诊断具体的应用卡顿原因前，请确保已经为应用部署了 TAPM 探针。然后通过以下步骤进行诊断：
1. 登录 [应用性能监控控制台](https://console.cloud.tencent.com/tapm)。
2. 在左侧导航栏中选择【应用】，然后在页面左上角的【业务系统】下拉菜单中选择应用所属的业务系统，在右上角选择发生卡顿的时间段。
3. 在应用列表中找到发生卡顿的应用，单击查看健康度是否变成警戒或者严重状态，平均响应时间、错误率是否过高。如果过高，单击卡顿应用的名称，进入应用详情页面。
   ![](https://main.qcloudimg.com/raw/6a4dd4a0988648d30fb72e8ed4d9a83a.png)
4. 从拓扑图中可以看到该应用在调用其他应用、MQ、数据库或者 NoSQL 的连线是否变黄或者变红。此时已大致能判断哪个部分出了问题。
5. 继续看下面的三个图表，主要看吞吐率和错误率是否有大的变化。
   一般来说，应用的错误率、吞吐率等指标会保持平稳的状态，如果突然升高，可能有以下原因：
   - 对功能进行了迭代升级，导致错误率升高。
   - 应用实例掉线了，导致吞吐率升高，由于应用负载有限，导致应用响应时间变长。
   - 举办活动、促销、或应用的使用高峰时段，吞吐率的增加会导致应用超负荷，应用响应时间变长。
   - 内存溢出，应用响应时间变长。
     ![](https://main.qcloudimg.com/raw/9659c407a8b3a305d3be1884ff7a0a7c.png)
6. 再看最下面的**应用组件响应时间**堆叠图，这个图展示的是应用中所有事务的响应时间的构成部分分别所占用的时间。构成部分包含代码执行时间、各类数据库访问时间、各类 NoSQL 访问时间、各类 MQ 访问时间、各类外部服务响应时间。我们能够清楚的看到具体是哪部分发生了变化，从而更加确认对拓扑图的判断。
   ![](https://main.qcloudimg.com/raw/8982434281ef9c8c2469e764154d49c5.png)
接下来我们分别从错误和组件响应时间两个思路来分析问题。

### 错误分析
1. 在页面顶部单击【错误】页签，进入该应用的错误统计分析页面。错误列表会列出应用发生的所有错误，默认按出现次数从高到低排序。下图中可以看到有一个 SQL 语法错误的异常持续了29分钟，发生了67次。
   ![](https://main.qcloudimg.com/raw/6bfe0927aa5e16611a95216fd350e304.png)
2. 单击错误条目，可以追踪这个错误都有哪些事务、服务接口或者后台任务发生过。
3. 在弹出框中单击一个接口名称，进入单个事务、服务接口或者后台任务的追踪页面。您可以根据右上角的各部分耗时占比判断问题所在，然后在堆栈页面中探究具体原因，可能会是调用服务组件出异常了、SQL 语句本身执行时间长、数据库连接池满了、代码本身的问题等等。该例中发现数据库异常，单击红框中的异常图标可查看异常信息和异常的堆栈，发现存在 SQL 语法问题。
![](https://main.qcloudimg.com/raw/0b66374decf5b7d0692360b6d7be7c1a.png)
![](https://main.qcloudimg.com/raw/64ecd634993688cf099cb237bec51df2.png)
4. 继续单击【SQL分析】页签，可追查具体影响到哪些完整的 SQL 语句。
操作至此，您已发现了应用卡顿的原因，这将有效地帮助您进行下一步的代码优化工作。

### 组件分析
如果已经判定是数据库组件出了问题，则可按照以下步骤进行诊断：
1. 在左侧导航栏中选择【服务组件】>【Database 组件】，然后在页面左上角的【业务系统】下拉菜单中选择数据库所属的业务系统，在右上角选择发生卡顿的时间段。
2. 对数据库实例列表按平均执行时间从高到低进行排序。单击执行时间最长的数据库实例名称，进入数据库概览页面。
3. 在上方单击【响应时间】页签，进一步分析数据库的性能问题。
   - **平均响应时间&吞吐率**：图表可以查看响应时间和吞吐率是否有波动。
   - **调用者分析**：展示所有调用该数据库实例的事务的性能详情。对列表按 SQL 响应时间从高到低排序，能看出哪些事务调用 SQL 语句时有性能问题。如果同时这个事务的调用占比很高，那么基本能断定是这个事务调用的 SQL 语句需要优化。注意，调用者（服务接口）例如果有值，说明是事务下游的服务接口调用的数据库实例。
   - **追踪列表**：可以查看由于调用该数据库实例而发生的所有事务追踪。对列表按 SQL 响应时间从高到低排序，单击事务的名称继续追踪具体的 SQL 语句。
4. 在追踪页面下方选择【SQL分析】页签，从平均执行时间列即可排查出需要优化的 SQL 语句了。
   ![](https://main.qcloudimg.com/raw/64de3f559478cd2c46e5021d9ce0ab0f.png)
5. 在追踪页面下方选择【调用栈】页签，单击下图红框中的数据库图标可以找到慢 SQL，继续单击【![](https://main.qcloudimg.com/raw/d1052032ea43986faa91381c8ed560f3.png)】
   图标可定位发生调用的代码位置。
![](https://main.qcloudimg.com/raw/16f972152a4d3f8bd6b695875b9c7da3.png)
操作至此，您已发现了应用卡顿的原因，这将有效地帮助您进行下一步的代码优化工作。其他组件的分析与数据库分析类似，您可以按照上述思路进行诊断。





