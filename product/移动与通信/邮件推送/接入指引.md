## 操作场景
邮件服务不是简单的即插即用服务，主流 ESP（Gmail，Outlook，Yahoo等）都有严格的反垃圾邮件措施。因此为了提高送达率，在发件规则和邮件质量上，需要业务方在发送业务上紧密配合。

邮件发送服务主要保证发件 IP 质量、DNS 规则配置准确、投递通道畅通。业务方不友好的发件举动可能会影响发件域名或者 IP 的信誉度，导致邮件被 ESP 送进用户垃圾箱，严重者封禁 IP 及域名的发件。一旦被封禁，原则上很难去拯救。

## 准备工作
### 需求对接
业务方需要与邮件服务团队沟通邮件发送的类型（注册/通知/营销）、发送场景、量级等，方便邮件服务团队为业务方量身提供发送计划，做好 Warmup。

### 客户对接
非标准 API 不再提供支持，客户全部走云上 API，API 文档以及 SES 控制台使用说明，请参见 [控制台指南](https://cloud.tencent.com/document/product/1288/55191)。

## 接入流程
### 第1步：选择邮件发送域名
1. 邮件发送域名建议采用三级及以上域名，如: mail.example.com，内部业务接入可委托 TCI 申请和配置域名。域名将托管在腾讯云。
2. 如果业务方自行配置，建议通过腾讯云购买个人专业版域名（如采用3级域名发件，需要配置5级子域名，免费版仅支持到4级域名），或者其它域名服务商。
>?不建议使用 GSLB 托管的域名。

### 第2步：配置域名及子域名 TXT 记录
1. 如果域名托管在 TCI，则可以忽略此步骤，由 TCI 配置好 DNS，等待48小时即可。
2. 申请域名之后，需要对域名进行一系列 DNS 配置，TCI 会提供配置表单详情，业务方配置完成后，需要最多48小时等待全球 DNS 信息同步。请参见 [全球 DNS 同步检测工具](https://www.whatsmydns.net/)。

### 第3步：设定邮件发送者
发送者即收件箱中用户所看到的发件人，如：user@mail.example.com。为避免出现滥用的 user，目前发件用户需要 TCI 添加配置。

### 第4步：邮件发送
TCI 确认 DNS 已同步，配置好邮件账号之后，即可调用 API 进行邮件发送。具体详情请参见 [API](https://cloud.tencent.com/document/product/1288/47445)。

### 第5步：接收发送结果回调
1. 发送 API 调用成功后，不等于邮件已经送达，有可能递送失败，ESP 拒收，邮箱地址无效等因素。业务方若想接收回调信息，需要在 TCI 配置回调地址，TCI 会将递送结果 POST 到该地址。
2. 邮件成功送达用户邮箱后，用户会有打开、点击其中 URL 等操作。业务方若想接收回调信息，需要在 TCI 配置回调地址，TCI 会将递送结果 POST 到该地址。

## 注意事项
### Warmup 发件预热（至关重要）
Warmup 是每个新的发件域或者 IP 的必经过程。邮件发送量必须是每日递增式的，不能一步到位达到理想的量级。发件量以（天）为单位，逐级递增。良好的 Warmup 可以在 ESP 取得良好的信誉度。每一个新的域名或者 IP 发件都应该遵循下面的 Warmup 计划：

| 时间 | 发送量/天 | 出信频率 |
| ------- | ------- | ------- | 
| 第1天     | 1000 | 200封/小时 |
| 第2天     |  1500 | 200封/小时 |
| 第3天     |  2000 | 400封/小时 |
| 第4天     |  3000 | 400封/小时 |
| 第5天     |  4500 | 500封/小时 |
| 第6-10天  | 6000-8000 | 500-1000封/小时 |
| 第11-15天 | 8000-10000 | 800-2000封/小时 |
| 第16-20天 | 10000-15000 | 1000-3000封/小时 |
| 第20-30天 | 15000-25000 | 3000-5000封/小时 |
| 第N天     | 每日增长一倍 |  |

1. 此表中的发信量与出信频率为建议值，仅供参考。
2. 发信预热是用来增加 IP 信誉度的，不能抱着探测 ISP 对 IP 的限制额度进行预热。
3. 当单个域的邮箱地址较多时，要适当的减少发信量进行预热。
4. 一个优质的 IP 或者域名，每天应有稳定的出信量，建议每周至少存在3天以上的发送。
5. 前期建议从地址库中随机选择地址，当发信量上升到一定量之后，再根据各个域的具体发送情况，针对性的预热。
6. 以上为单个 IP 的建议发件量上限，多个 IP 可以适量多发，单日建议最多不超出以上计划的5倍。
7. 正常的验证类邮件业务按目前的业务比例灰度即可，不一定严格遵循上述绝对数量，不超过上限即可。
8. 如果业务特性实在不满足 Warmup，可以转用已经 Warmup 好的公共域名和共享IP去发送，但是信誉度不能独立控制。
9. 如果业务特性实在不满足 Warmup，且业务量级小，且邮件为用户打开率高的注册邮件，每日发件不超过1万封，可以考虑跳过 Warmup 直接使用，但不推荐此方式。


### DNS有效性验证
DNS配置问题客户可以使用工具验证自己的 DNS 是否配置有效，请参见 [全球 DNS 同步检测工具](https://www.whatsmydns.net/)。

### 发件测试
正式发件之前，可以使用 [mail-tester 工具](https://www.mail-tester.com/) 进行邮件评测。该工具可以检查 DNS/IP 配置完整性和 IP 有效性，以及邮件内容的质量。DNS 配置完整的情况下，评分主要看邮件内容，一般来说，需要优化至评分不低于8分。
>?如果是开发自测，尽量不要在一天内对单个邮箱发送太多次邮件（建议每日不超过24次）。如果是正式上线，每天尽量不要给同一个用户发件超过10次。

### 邮箱地址有效性
bounce（邮件退回）率是 ESP 进行评分的一个硬性指标，被 bounce 的发件中，原可能的原因是邮箱地址无效，即发送到错误的目标地址，如果持续发送的 bounce 率过高，ESP 会判断为恶意的发件人，从而将邮件送到垃圾箱，或者封禁发件 IP。良好的邮件发送 bounce 率不应超过5%。如果业务方的邮箱地址质量太差，需要先进行预处理过滤。

### 垃圾箱
任何发送者都无法保证邮件不进入用户的垃圾箱，特别是新域名初始状态下，在 ESP 处无任何信誉度。进入用户垃圾箱是正常现象，需要靠良好的 Warmup 和用户参与来提高域名信誉度，ESP 会根据信誉度动态调节，最终将邮件送至用户收件箱。因为建议所有业务侧增加"如果没有收到邮件，请检查垃圾箱"的用户提示。

### 用户打开率
用户打开率也是衡量邮件是否会进入收件箱的重要指标。用户参与度越高，ESP 会相应提高域名的信誉度。一般来说，注册邮件的打开率在80%以上为正常。通知类视业务场景而定，营销类邮件需要业务侧不断去优化标题和内容，达到用户主动参与的效果。该指标低于50%视为进入垃圾箱的危险信号。

## 其它
### 静态IP
TCI 会为专有域名使用独立的 IP，以保持独立业务域名之间的信誉度隔离。静态 IP 适用于持续有流量的业务，间断性业务不适用静态 IP。如果单个 IP 超过3日未发送邮件，则需要重新 Warmup

### 邮件发送模板
平台支持邮件模板功能，可以在平台创建模板代码，发送时传变量值即可，请参见 [控制台发信模板](https://console.cloud.tencent.com/ses/template)。 选择 【新建模版】，创建自定义模板，变量使用`{{.变量名}}`标识，发送是按照协议传变量字段即可。
